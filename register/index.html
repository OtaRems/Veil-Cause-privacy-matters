<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" style="height:100%">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veil - Registrazione</title>
    <link rel="manifest" href="../manifest.json">
    <script src="../js/jquery-3.7.1.min.js.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="../js/app.js"></script>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
</head>
<body class="h-100 d-flex justify-content-center align-items-center">

    <!--Sezione Principale-->
    <section class="container h-75 secbg rounded-4 shadow-lg p-0">
        <div class="row g-0 h-100">
            <!--Colonna di sinistra-->
            <div class="col-5 h-100 p-3">
            <div class="evidbg text-center rounded-2 w-100 h-100 p-5 align-content-center">
                    <p class="mt-4 h2"><strong>
                        "La tua privacy non dovrebbe essere un lusso, ma una <span class="text-danger">certezza</span>."
                    </strong></p>
                </div>
            </div>
            <!--Colonna di destra-->
            <div id="mainbox" class="col-7 h-100 p-5 text-center">
                <form class="mx-5 needs-validation" novalidate>
                    <img src="../img/Logogreen.png" alt="Logo" style="width:3rem">
                    <h1>Benvenuto in Veil!</h1>
                    <p class="text-secondary">Perché la privacy è un diritto umano</p>
                    <!--Username-->
                    <div class="form-floating mb-3 mt-5">
                        <input type="text" class="form-control" id="UserInput" placeholder="" pattern="^[A-Za-z][A-Za-z0-9]{0,19}$" maxlength="20" required>
                        <label for="UserInput">Inserisci un username</label>
                        <div id="userfeed" class="invalid-feedback text-start">Inserisci un username valido!</div>
                    </div>
                    <!-- Password -->
                    <div class="form-floating mb-3 mt-5 position-relative">
                        <input type="password" class="form-control" id="PasswordInput" placeholder="" required pattern="^(?!.*\s)(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{10,}$" maxlength="26" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="custom-tooltip" data-bs-title="Ricorda di segnare la tua password per non perdere l'accesso all'account! per motivi di privacy non abbiamo aggiunto il recupero password, per ciò se la perdi, hai perso tutto.">
                        <label for="PasswordInput">Inventa una password sicura</label>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 512" class="position-absolute top-0 end-0 translate-middle-y me-3" id="togglePassword" style="cursor: pointer; color:var(--bs-secondary); width: 1.5rem; margin-top:1.9rem;"><path fill="#aeb2b6" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM144 256a144 144 0 1 1 288 0 144 144 0 1 1 -288 0zm144-64c0 35.3-28.7 64-64 64c-7.1 0-13.9-1.2-20.3-3.3c-5.5-1.8-11.9 1.6-11.7 7.4c.3 6.9 1.3 13.8 3.2 20.7c13.7 51.2 66.4 81.6 117.6 67.9s81.6-66.4 67.9-117.6c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3z"/></svg>
                        <div class="text-start" id="passfeed">
                            <small class="text-danger-emphasis" id="f1">Almeno 10 caratteri, senza spazi</small><br>
                            <small class="text-danger-emphasis" id="f2">Maiuscole + minuscole + numeri</small><br>
                            <small class="text-danger-emphasis" id="f3">Almeno 1 carattere speciale (@!/-)</small>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary mt-1 mb-3 w-100 p-3">Crea Account</button>
                    <div id="bottom-text">
                        <a class="form-text" href="../login/">Hai già un account? Accedi qui</a>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <p class="text-secondary position-absolute start-50 bottom-0 translate-middle"><small>SHA256 checksum: c94a9928b664d36533d2ec38e20633f194699d68b46ab9cf0f4e83a176b4ea18</small></p>
    <script src="../js/Argon2id.min.js"></script>
    <script>

        //per i tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        //Mostra/Nascondi password
        $("#togglePassword").click(function() {
            let pinput = $("#PasswordInput");
            let icon = $(this)
            if (pinput.attr("type") === "password") {
                pinput.attr("type", "text");
                icon.html('<path fill="#aeb2b6" d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c8.4-19.3 10.6-41.4 4.8-63.3c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zM373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5L373 389.9z"/>                ')
            } else {
                pinput.attr("type", "password");
                icon.html('<path fill="#aeb2b6" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM144 256a144 144 0 1 1 288 0 144 144 0 1 1 -288 0zm144-64c0 35.3-28.7 64-64 64c-7.1 0-13.9-1.2-20.3-3.3c-5.5-1.8-11.9 1.6-11.7 7.4c.3 6.9 1.3 13.8 3.2 20.7c13.7 51.2 66.4 81.6 117.6 67.9s81.6-66.4 67.9-117.6c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3z"/>')
            }
        })

        //submit del form
        $("form").on("submit", function(event) {
            event.preventDefault();
            //controllo sugli input tramite regexp
            if (!this.checkValidity()) {
                    event.stopPropagation();
                }
                else {
                    let user = $("#UserInput").val()
                    let pass = $("#PasswordInput").val()
                    $("#bottom-text").html('<div class="spinner-border spinner-border-sm text-success" role="status"></div><span> Caricamento..</span>')
                    //primo hash della password, lato client con l'algoritmo Argon2iD
                    let argon = "";
                    let salt = Argon2id.randomSalt();

                    setTimeout( function() {
                        Argon2id.hash(pass, salt, 3, 4000, 1,    32).then(hash => {
                        argon = hash;

                        //invio di user + hash + salt al server
                        $.ajax({
                        url: "register.php",
                        method: "POST",
                        data:  {username:user, pass: argon, salt: salt},
                        success: function (result) {
                            console.log(result)
                            if (result == "0") {
                                $("#mainbox").addClass("align-content-center")
                                $("#mainbox").html('<h3>Il tuo account è stato creato con successo!</h3><p>Ora puoi effettuare il login tramite la pagina apposita</p><a  class="btn btn-primary px-5 mt-3" href="../login/">Login</a>');
                            } else {
                                $("#UserInput").val("")
                                $("#userfeed").html("Esiste già un utente con questo username!")
                                $("#bottom-text").html('<a class="form-text" href="../login/">Hai già un account? Accedi qui</a>')
                            }
                        }
                        });
                    });
                    }, 50)
                    
                }

            $(this).addClass("was-validated");
        })

        let pinput = $("#PasswordInput")
        const reg0 = /^(?!.*\s).{10,}$/;
        const reg1 = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).*$/;
        const reg2 = /(?!.*\s)[^A-Za-z0-9]/;
        pinput.on("keyup", function() {
            if (reg0.test(pinput.val()))
                $("#f1").removeClass("text-danger-emphasis").addClass("text-success-emphasis")
            else
                $("#f1").removeClass("text-success-emphasis").addClass("text-danger-emphasis")
            if(reg1.test(pinput.val()))
                $("#f2").removeClass("text-danger-emphasis").addClass("text-success-emphasis")
            else
                $("#f2").removeClass("text-success-emphasis").addClass("text-danger-emphasis")
            if(reg2.test(pinput.val()))
                $("#f3").removeClass("text-danger-emphasis").addClass("text-success-emphasis")
            else
                $("#f3").removeClass("text-success-emphasis").addClass("text-danger-emphasis")

        })
    </script>
</body> 
</html>